<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ClarityBrief — Confirm profile</title>
  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f1a2e;
      --panel2:#0c172b;
      --stroke:rgba(255,255,255,.10);
      --stroke2:rgba(255,255,255,.14);
      --text:#e8eefc;
      --muted:rgba(232,238,252,.72);
      --muted2:rgba(232,238,252,.58);
      --brand:#6ee7ff;
      --brand2:#a78bfa;
      --good:#34d399;
      --warn:#fbbf24;
      --bad:#fb7185;
      --shadow: 0 18px 50px rgba(0,0,0,.35);
      --radius: 16px;
      --radius2: 22px;
      --max: 1200px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 20% 0%, rgba(110,231,255,.18), transparent 55%),
        radial-gradient(900px 700px at 90% 10%, rgba(167,139,250,.14), transparent 55%),
        radial-gradient(900px 700px at 50% 100%, rgba(52,211,153,.08), transparent 60%),
        linear-gradient(180deg, #070c16, #0b1220 55%, #070c16);
    }
    a{color:inherit; text-decoration:none}
    .wrap{max-width:var(--max); margin:0 auto; padding: 22px 18px 64px}

    /* Topbar */
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      padding: 14px 14px;
      border: 1px solid var(--stroke);
      background: rgba(15,26,46,.55);
      backdrop-filter: blur(10px);
      border-radius: var(--radius2);
      box-shadow: 0 10px 30px rgba(0,0,0,.18);
    }
    .brand{
      display:flex; align-items:center; gap:10px; font-weight:750; letter-spacing:.2px;
    }
    .logo{
      width:34px; height:34px; border-radius: 12px;
      background: linear-gradient(135deg, rgba(110,231,255,.95), rgba(167,139,250,.9));
      box-shadow: 0 10px 25px rgba(110,231,255,.12);
      position:relative;
    }
    .logo:after{
      content:"";
      position:absolute; inset:9px;
      border-radius: 10px;
      background: rgba(11,18,32,.70);
      border: 1px solid rgba(255,255,255,.18);
    }
    .nav{
      display:flex; align-items:center; gap:10px;
      font-size: 14px;
      color: var(--muted);
      flex-wrap: wrap;
      justify-content: flex-end;
    }
    .pill{
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      font-size: 12px;
      color: var(--muted);
      white-space:nowrap;
    }
    .link{
      color: rgba(232,238,252,.85);
      text-decoration: underline;
      text-underline-offset: 2px;
      font-size: 13px;
    }

    /* Onboarding strip */
    .strip{
      margin-top: 14px;
      padding: 12px 14px;
      border-radius: var(--radius2);
      border: 1px solid var(--stroke);
      background: rgba(15,26,46,.42);
      backdrop-filter: blur(10px);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      flex-wrap: wrap;
    }
    .steps{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items:center;
      color: var(--muted);
      font-size: 13px;
    }
    .step{
      display:inline-flex; align-items:center; gap:8px;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
    }
    .step .n{
      width:18px; height:18px; border-radius: 7px;
      display:flex; align-items:center; justify-content:center;
      font-family: var(--mono);
      font-size: 11px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.04);
      color: rgba(232,238,252,.85);
    }
    .step.active{
      border-color: rgba(110,231,255,.35);
      background: rgba(110,231,255,.08);
      color: rgba(232,238,252,.92);
    }
    .step.active .n{
      border-color: rgba(110,231,255,.45);
      background: rgba(110,231,255,.14);
    }
    .eta{
      color: var(--muted2);
      font-size: 13px;
    }

    /* Main layout */
    .grid{
      margin-top: 16px;
      display:grid;
      grid-template-columns: 1.1fr 0.9fr;
      gap: 14px;
      align-items:start;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns: 1fr}
    }
    .panel{
      background: rgba(15,26,46,.55);
      border: 1px solid var(--stroke);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      padding: 20px;
      backdrop-filter: blur(10px);
    }
    h1{
      margin: 0;
      font-size: 22px;
      letter-spacing: -0.3px;
    }
    .sub{
      margin-top: 8px;
      color: var(--muted);
      font-size: 14px;
      line-height: 1.55;
      max-width: 78ch;
    }

    /* Form components */
    .sectionTitle{
      margin: 0;
      font-size: 13px;
      font-weight: 900;
      letter-spacing: .2px;
      text-transform: uppercase;
      color: rgba(232,238,252,.82);
    }
    .card{
      margin-top: 12px;
      padding: 14px;
      border-radius: var(--radius2);
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
    }
    .fieldGrid{
      margin-top: 10px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 680px){
      .fieldGrid{grid-template-columns: 1fr}
    }
    .field label{
      display:block;
      font-size: 12px;
      color: rgba(232,238,252,.85);
      font-weight: 800;
      margin-bottom: 6px;
    }
    .input{
      width:100%;
      padding: 11px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      color: var(--text);
      outline: none;
      transition: .15s ease;
    }
    .input:focus{
      border-color: rgba(110,231,255,.45);
      box-shadow: 0 0 0 4px rgba(110,231,255,.10);
    }
    .hint{
      margin-top: 6px;
      color: var(--muted2);
      font-size: 12px;
      line-height: 1.45;
    }

    /* Required chips */
    .reqRow{
      margin-top: 10px;
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items:center;
      justify-content:space-between;
    }
    .req{
      display:inline-flex; align-items:center; gap:8px;
      padding: 6px 9px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      color: var(--muted);
      font-size: 12px;
      white-space: nowrap;
    }
    .dot{
      width:8px; height:8px; border-radius:999px;
      background: var(--warn);
      box-shadow: 0 0 0 4px rgba(251,191,36,.10);
    }
    .dot.good{background: var(--good); box-shadow:0 0 0 4px rgba(52,211,153,.10)}
    .dot.bad{background: var(--bad); box-shadow:0 0 0 4px rgba(251,113,133,.10)}

    /* Role accordion */
    details{
      margin-top: 10px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.02);
      overflow:hidden;
    }
    summary{
      cursor:pointer;
      padding: 12px 12px;
      list-style:none;
      font-weight: 900;
      color: rgba(232,238,252,.90);
      font-size: 13px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    summary::-webkit-details-marker{display:none}
    .summaryMeta{
      color: var(--muted2);
      font-weight: 700;
      font-size: 12px;
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items:center;
    }
    .pillSmall{
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      font-size: 11px;
      color: var(--muted);
      white-space:nowrap;
      font-family: var(--mono);
    }
    .detailsBody{
      padding: 0 12px 12px;
    }

    /* Original resume */
    .resumeBox{
      margin-top: 12px;
      width:100%;
      min-height: 520px;
      resize: vertical;
      padding: 14px 14px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      color: rgba(232,238,252,.90);
      outline:none;
      line-height: 1.45;
      font-size: 12px;
      font-family: var(--mono);
      white-space: pre-wrap;
    }
    .resumeBox:focus{
      border-color: rgba(110,231,255,.45);
      box-shadow: 0 0 0 4px rgba(110,231,255,.10);
    }

    /* Actions */
    .ctaRow{
      margin-top: 14px;
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items:center;
      justify-content:space-between;
    }
    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      gap:10px;
      padding: 11px 14px;
      border-radius: 14px;
      border: 1px solid var(--stroke2);
      background: rgba(255,255,255,.04);
      color: var(--text);
      font-weight: 850;
      cursor:pointer;
      transition: .15s ease;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{transform: translateY(-1px); border-color: rgba(255,255,255,.18); background: rgba(255,255,255,.06)}
    .btn:active{transform: translateY(0px)}
    .btn.primary{
      border-color: rgba(110,231,255,.35);
      background: linear-gradient(135deg, rgba(110,231,255,.22), rgba(167,139,250,.18));
      box-shadow: 0 14px 40px rgba(110,231,255,.10);
    }
    .btn.primary:hover{
      border-color: rgba(110,231,255,.50);
      box-shadow: 0 14px 45px rgba(110,231,255,.14);
    }
    .btn.disabled{
      opacity: .55;
      cursor: not-allowed;
      transform:none !important;
    }

    .alert{
      margin-top: 12px;
      border-radius: 16px;
      padding: 12px 12px;
      border: 1px solid rgba(251,113,133,.25);
      background: rgba(251,113,133,.06);
      color: rgba(232,238,252,.88);
      font-size: 13px;
      line-height: 1.55;
      display:none;
    }
    .alert b{color: rgba(232,238,252,.95)}
    .note{
      margin-top: 12px;
      padding: 12px;
      border-radius: 16px;
      border: 1px dashed rgba(255,255,255,.18);
      background: rgba(255,255,255,.02);
      color: var(--muted);
      font-size: 13px;
      line-height: 1.55;
    }
    .footer{
      margin-top: 22px;
      padding-top: 14px;
      border-top: 1px solid rgba(255,255,255,.10);
      display:flex;
      gap: 10px;
      align-items:flex-start;
      justify-content:space-between;
      flex-wrap: wrap;
      color: var(--muted2);
      font-size: 13px;
    }
    .footer a{color: var(--muted); text-decoration: underline; text-underline-offset: 2px}

    .muted{color: var(--muted)}
    .kbd{
      font-family: var(--mono);
      font-size: 11px;
      padding: 3px 7px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      color: rgba(232,238,252,.85);
      white-space:nowrap;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <!-- Top Bar -->
    <header class="topbar">
      <div class="brand" aria-label="Product">
        <a href="01_landing.html" style="display:flex;align-items:center;gap:10px;">
          <div class="logo" aria-hidden="true"></div>
          <div>
            <div style="display:flex;align-items:baseline;gap:8px;">
              <div style="font-size:15px;">ClarityBrief</div>
              <div style="font-size:12px;color:var(--muted);font-weight:650;">Confirm profile</div>
            </div>
          </div>
        </a>
      </div>

      <nav class="nav" aria-label="Top navigation">
        <span class="pill" id="trialPill">Trial: Day 1 of 7</span>
        <a class="link" href="07_done.html">Home</a>
        <a class="link" href="09_job_intake.html">Analyze a job</a>
        <a class="link" href="08_preferences.html">Preferences</a>
        <a class="link" href="12_saved_briefs.html">Saved briefs</a>
        <a class="link" href="13_trends.html">Trends</a>
      </nav>
    </header>

    <!-- Onboarding strip -->
    <div class="strip" aria-label="Onboarding progress">
      <div class="steps">
        <span class="step"><span class="n">1</span>Account</span>
        <span class="step"><span class="n">2</span>Resume</span>
        <span class="step"><span class="n">3</span>Results</span>
        <span class="step active"><span class="n">4</span>Confirm</span>
        <span class="step"><span class="n">5</span>Done</span>
      </div>
      <div class="eta">Confirm key fields. Leave unknowns explicit.</div>
    </div>

    <div class="grid" aria-label="Confirm layout">
      <!-- Left: structured profile -->
      <main class="panel" aria-label="Structured profile confirmation">
        <h1>Confirm your structured profile</h1>
        <p class="sub">
          This is what the system believes based on your pasted resume. Confirming improves downstream decision quality.
          If you don’t know a field, you can set it to <span class="kbd">Unknown</span> — we’ll keep that uncertainty visible.
        </p>

        <div class="card" aria-label="Identity and current role">
          <div class="sectionTitle">Key confirmations (most important)</div>

          <div class="fieldGrid">
            <div class="field">
              <label for="fullName">Full name (optional)</label>
              <input class="input" id="fullName" placeholder="e.g., Walid S Newaz" />
              <div class="hint">Used for your saved profile. Not shown to employers.</div>
            </div>
            <div class="field">
              <label for="location">Primary location (optional)</label>
              <input class="input" id="location" placeholder="e.g., Denver, CO" />
              <div class="hint">Helps interpret relocation constraints later (optional).</div>
            </div>
          </div>

          <div class="fieldGrid">
            <div class="field">
              <label for="currentTitle">Current role title <span class="muted">(required)</span></label>
              <input class="input" id="currentTitle" placeholder="e.g., Senior Frontend Engineer" />
              <div class="hint">Used to calibrate seniority and target roles.</div>
            </div>
            <div class="field">
              <label for="currentCompany">Current company <span class="muted">(required)</span></label>
              <input class="input" id="currentCompany" placeholder="e.g., FinTechCo" />
              <div class="hint">Company name can be generalized if you prefer.</div>
            </div>
          </div>

          <div class="fieldGrid">
            <div class="field">
              <label for="currentStart">Current role start date <span class="muted">(required)</span></label>
              <input class="input" id="currentStart" placeholder="e.g., Feb 2021 or Unknown" />
              <div class="hint">Month/year improves timeline confidence.</div>
            </div>
            <div class="field">
              <label for="workAuth">Work authorization <span class="muted">(optional)</span></label>
              <input class="input" id="workAuth" placeholder="e.g., US Citizen, H-1B, TN, Unknown" />
              <div class="hint">Optional now; can be set in preferences later.</div>
            </div>
          </div>

          <div class="reqRow" aria-label="Required status">
            <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
              <span class="req" id="reqTitle"><span class="dot"></span>Current title</span>
              <span class="req" id="reqCompany"><span class="dot"></span>Current company</span>
              <span class="req" id="reqStart"><span class="dot"></span>Current start date</span>
            </div>
            <span class="pill" id="completionPill">0% confirmed</span>
          </div>

          <div class="alert" id="alertBox">
            <b>Missing required confirmations.</b> Please confirm current title, company, and start date (or set to <span class="kbd">Unknown</span>).
          </div>
        </div>

        <div class="card" aria-label="Roles timeline">
          <div class="sectionTitle">Experience timeline (edit as needed)</div>
          <div class="muted" style="margin-top:8px; font-size: 13px; line-height: 1.55;">
            These roles were inferred from your resume. Confirm titles, companies, and dates. You can keep ambiguous dates as <span class="kbd">Unknown</span>.
          </div>

          <div id="rolesMount"></div>

          <div class="note">
            <b>Tip:</b> If you want to promote honesty and avoid accidental embellishment, focus on clarifying
            <b>scope</b> and <b>outcomes</b> rather than adding new claims.
          </div>
        </div>

        <div class="ctaRow" aria-label="Actions">
          <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <button class="btn primary" id="saveBtn" type="button" onclick="saveAndContinue()">
              Save and continue <span aria-hidden="true">→</span>
            </button>
            <button class="btn disabled" type="button" onclick="alert('Placeholder: re-run analysis');">
              Re-run analysis (coming soon)
            </button>
          </div>
          <a class="link" href="05_results.html">Back</a>
        </div>

        <div class="note" aria-label="Boundary note">
          <b>Boundary:</b> This confirmation step improves what the system can infer.
          It does not verify truth. Employers remain the final verifier.
        </div>
      </main>

      <!-- Right: original resume text -->
      <aside class="panel" aria-label="Original resume text">
        <div class="sectionTitle">Original resume text (read-only in prototype)</div>
        <div class="muted" style="margin-top:8px; font-size: 13px; line-height: 1.55;">
          Keep this panel visible while you confirm role fields. Later we’ll support versioning and evidence traceability.
        </div>

        <textarea id="resumeRaw" class="resumeBox" readonly></textarea>

        <div class="note">
          <b>Why show the source?</b> Decision-support is stronger when you can see what the system used as evidence.
          This helps you spot hallucinations or mis-parsing.
        </div>
      </aside>
    </div>

    <!-- Footer -->
    <footer class="footer" aria-label="Footer">
      <div>
        <div style="font-weight:850; color: rgba(232,238,252,.80);">ClarityBrief</div>
        <div style="margin-top:4px;">Make assumptions visible. Improve them intentionally.</div>
      </div>
      <div style="display:flex; gap: 14px; flex-wrap:wrap;">
        <a href="#" onclick="alert('Placeholder: privacy policy'); return false;">Privacy</a>
        <a href="#" onclick="alert('Placeholder: terms'); return false;">Terms</a>
      </div>
    </footer>
  </div>

  <script>
    function getUser(){
      try { return JSON.parse(localStorage.getItem('cb_mock_user') || 'null'); }
      catch { return null; }
    }
    function computeTrialDay(user){
      if(!user?.trialStartISO) return 1;
      const start = new Date(user.trialStartISO);
      const now = new Date();
      const diffDays = Math.max(0, Math.floor((now - start) / (1000*60*60*24)));
      return Math.min((user.trialDays || 7), diffDays + 1);
    }
    function updateTrialPill(){
      const user = getUser();
      const day = computeTrialDay(user);
      const total = user?.trialDays || 7;
      document.getElementById('trialPill').textContent = `Trial: Day ${day} of ${total}`;
    }

    function escapeHtml(s){
      return String(s || '')
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
    }

    // Minimal inference of roles (prototype):
    // - Use stored mock results if available; else create 2 sample roles.
    function inferRolesFromResume(raw){
      // Extremely naive: look for lines like "Title — Company | Date – Date"
      const lines = String(raw || '').split(/\r?\n/);
      const roles = [];
      const rolePattern = /^(.*?)\s+[—-]\s+(.*?)\s+\|\s+(.*)$/;
      for(const line of lines){
        const m = line.match(rolePattern);
        if(m){
          const title = m[1].trim();
          const company = m[2].trim();
          const dates = m[3].trim();
          let start = 'Unknown', end = 'Unknown';
          // Try split dates like "Feb 2021 – Present"
          const parts = dates.split(/–|-/).map(s=>s.trim());
          if(parts.length >= 2){
            start = parts[0] || 'Unknown';
            end = parts[1] || 'Unknown';
          } else if(parts.length === 1 && parts[0]) {
            start = parts[0];
          }
          roles.push({
            id: 'role_' + (roles.length+1),
            title, company, start, end,
            notes: "Review scope and outcomes in bullets."
          });
        }
      }
      if(roles.length) return roles;

      // Fallback roles
      return [
        { id:'role_1', title:'Senior Full Stack Engineer', company:'FinTechCo', start:'Feb 2021', end:'Present', notes:'Confirm exact start month/year.' },
        { id:'role_2', title:'Frontend Engineer', company:'EnterpriseBank', start:'Jun 2018', end:'Jan 2021', notes:'Confirm title and end date.' },
        { id:'role_3', title:'Software Engineer', company:'SaaSWorks', start:'Aug 2016', end:'May 2018', notes:'Optional to confirm.' }
      ];
    }

    function roleEditor(role, idx){
      const isCurrent = role.end.toLowerCase().includes('present') || role.end.toLowerCase().includes('current');
      const required = idx === 0 || isCurrent; // require first/current role for prototype
      const reqPill = required ? `<span class="pillSmall" style="border-color: rgba(251,191,36,.28); background: rgba(251,191,36,.08);">required</span>` :
                                `<span class="pillSmall">optional</span>`;
      const currentPill = isCurrent ? `<span class="pillSmall" style="border-color: rgba(52,211,153,.28); background: rgba(52,211,153,.08);">current</span>` : '';

      return `
        <details ${idx===0 ? 'open' : ''} data-role-id="${escapeHtml(role.id)}">
          <summary>
            <div>
              ${escapeHtml(role.title)} — ${escapeHtml(role.company)}
              <div class="summaryMeta">
                <span>${escapeHtml(role.start)} → ${escapeHtml(role.end)}</span>
                ${reqPill} ${currentPill}
              </div>
            </div>
            <div class="summaryMeta">Edit</div>
          </summary>
          <div class="detailsBody">
            <div class="fieldGrid">
              <div class="field">
                <label>Title ${required ? '<span class="muted">(confirm)</span>' : ''}</label>
                <input class="input roleTitle" value="${escapeHtml(role.title)}" placeholder="e.g., Senior Frontend Engineer" />
              </div>
              <div class="field">
                <label>Company ${required ? '<span class="muted">(confirm)</span>' : ''}</label>
                <input class="input roleCompany" value="${escapeHtml(role.company)}" placeholder="e.g., Acme Corp" />
              </div>
            </div>
            <div class="fieldGrid">
              <div class="field">
                <label>Start date ${required ? '<span class="muted">(confirm)</span>' : ''}</label>
                <input class="input roleStart" value="${escapeHtml(role.start)}" placeholder="e.g., Feb 2021 or Unknown" />
              </div>
              <div class="field">
                <label>End date</label>
                <input class="input roleEnd" value="${escapeHtml(role.end)}" placeholder="e.g., Present or Jan 2021 or Unknown" />
              </div>
            </div>
            <div class="hint">${escapeHtml(role.notes || 'Confirm for accuracy.')}</div>
          </div>
        </details>
      `;
    }

    function mountRoles(roles){
      const html = roles.map((r,i)=>roleEditor(r,i)).join('');
      document.getElementById('rolesMount').innerHTML = html;
    }

    function setReqChip(id, ok){
      const el = document.getElementById(id);
      if(!el) return;
      el.innerHTML = `<span class="dot ${ok ? 'good' : ''}"></span>${el.textContent.replace(/^.*?\s/, '')}`; // keep label rough
      // Since we rewrote innerHTML, restore exact label:
      const labels = { reqTitle: 'Current title', reqCompany: 'Current company', reqStart: 'Current start date' };
      el.innerHTML = `<span class="dot ${ok ? 'good' : ''}"></span>${labels[id]}`;
    }

    function isKnownOrUnknown(v){
      const s = String(v || '').trim();
      return s.length > 0; // allow "Unknown" explicitly, but any non-empty passes
    }

    function updateCompletion(){
      const title = document.getElementById('currentTitle').value;
      const comp = document.getElementById('currentCompany').value;
      const start = document.getElementById('currentStart').value;

      const okTitle = isKnownOrUnknown(title);
      const okComp = isKnownOrUnknown(comp);
      const okStart = isKnownOrUnknown(start);

      setReqChip('reqTitle', okTitle);
      setReqChip('reqCompany', okComp);
      setReqChip('reqStart', okStart);

      const okCount = [okTitle, okComp, okStart].filter(Boolean).length;
      const pct = Math.round((okCount / 3) * 100);
      document.getElementById('completionPill').textContent = `${pct}% confirmed`;

      const alertBox = document.getElementById('alertBox');
      if(okCount < 3) alertBox.style.display = 'block';
      else alertBox.style.display = 'none';

      const saveBtn = document.getElementById('saveBtn');
      if(okCount < 3){
        saveBtn.classList.add('disabled');
      } else {
        saveBtn.classList.remove('disabled');
      }
    }

    function loadResumeRaw(){
      const raw = localStorage.getItem('cb_mock_resume_raw') || '';
      document.getElementById('resumeRaw').value = raw || 'No resume text found. Go back and paste resume.';
      return raw;
    }

    function hydrateFromRaw(raw){
      // Populate current role from inferred roles if user didn't type.
      const roles = inferRolesFromResume(raw);
      mountRoles(roles);

      // Choose current role: first role with "Present", else first role
      const current = roles.find(r => String(r.end||'').toLowerCase().includes('present') || String(r.end||'').toLowerCase().includes('current')) || roles[0];

      const ct = document.getElementById('currentTitle');
      const cc = document.getElementById('currentCompany');
      const cs = document.getElementById('currentStart');

      if(!ct.value.trim()) ct.value = current?.title || '';
      if(!cc.value.trim()) cc.value = current?.company || '';
      if(!cs.value.trim()) cs.value = current?.start || '';

      // Add listeners for role editors (optional in prototype; but capture on save)
      updateCompletion();
    }

    function collectRoles(){
      const roles = [];
      const blocks = document.querySelectorAll('details[data-role-id]');
      blocks.forEach((d, idx) => {
        const id = d.getAttribute('data-role-id') || ('role_' + (idx+1));
        const title = d.querySelector('.roleTitle')?.value || '';
        const company = d.querySelector('.roleCompany')?.value || '';
        const start = d.querySelector('.roleStart')?.value || '';
        const end = d.querySelector('.roleEnd')?.value || '';
        roles.push({ id, title, company, start, end });
      });
      return roles;
    }

    function saveAndContinue(){
      const btn = document.getElementById('saveBtn');
      if(btn.classList.contains('disabled')){
        alert('Please confirm required fields first (or set to "Unknown").');
        return;
      }

      const profile = {
        confirmedAtISO: new Date().toISOString(),
        identity: {
          fullName: document.getElementById('fullName').value.trim() || null,
          location: document.getElementById('location').value.trim() || null
        },
        current: {
          title: document.getElementById('currentTitle').value.trim(),
          company: document.getElementById('currentCompany').value.trim(),
          start: document.getElementById('currentStart').value.trim(),
          workAuth: document.getElementById('workAuth').value.trim() || null
        },
        roles: collectRoles()
      };

      try { localStorage.setItem('cb_mock_profile_confirmed', JSON.stringify(profile)); }
      catch (_) {}

      window.location.href = '07_done.html';
    }

    // init
    updateTrialPill();
    const raw = loadResumeRaw();
    hydrateFromRaw(raw);

    // field listeners
    ['currentTitle','currentCompany','currentStart'].forEach(id => {
      document.getElementById(id).addEventListener('input', updateCompletion);
    });
  </script>
</body>
</html>
